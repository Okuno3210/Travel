<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <title>アメリカ観光地ガイド | TravelMap</title>
</head>
<body>
  <header>
    <h1>🇺🇸 アメリカの人気観光地</h1>
    <p>多様な文化と絶景が共存する国 — 自由の女神、グランドキャニオン、ナイアガラの滝など</p>
  </header>
  <div style="display: flex; align-items: center;">
     <img th:src="@{/images/country/America.png}" alt="アメリカ" style="width:700px; height:auto; margin-right:15px;">
     <p>夢を追いかける人々の街、世界の映画産業の中心地。 「ハリウッド・サイン」を背景に記念写真を撮り、スターの仲間入り気分を味わいましょう。 ハリウッド大通りでは、有名俳優たちの手形やサインが刻まれた「ウォーク・オブ・フェーム」を散策。 TCLチャイニーズ・シアターで、お気に入りのスターの足跡を見つけるのも楽しみの一つです。 映画史の栄光と、現代のエンターテイメントが交差するこの場所で、あなただけのストーリーを見つけてください。 誰もが知る“あの”場所で、きらめく才能の気配を感じましょう。</p>
   </div>
  <main>
    <div th:if="${spots != null and !#lists.isEmpty(spots)}" class="spot-grid">
      <div class="card" th:each="s : ${spots}" th:if="${s.country == 'アメリカ'}">
        <img th:src="${s.image}" th:alt="${s.name}" />
        <div class="card-content">
          <h3 th:text="${s.name}"></h3>
          <p th:text="${s.desc}"></p>
          <a th:href="@{/spots/detail/{key}(key=${s.key})}" class="btn">詳細を見る</a>
        </div>
      </div>
    </div>

    <div th:if="${spots == null or #lists.isEmpty(spots)}">
      <p>アメリカの観光地データが見つかりませんでした。</p>
    </div>
  </main>

 
  <div id="rates"></div>
  
  <form id="searchForm"> <!--検索用ここから-->
    <label>行きたい国:</label>
	<select id="countryName"><option value="">すべて</option></select><br><br>
	
	<label>行きたい地域:</label>
      <select id="regionId"><option value="">すべて</option></select><br><br>
	  
	 <label>ご旅行の目的</label>
	 <select id="<!--conceptId入れる-->"><option value="">何でも</option></select><br><br>

      <label>観光名所:</label>
      <select id="spotId"><option value="">すべて</option></select><br><br>

      <label>渡航時間:</label>
      <select id="travelTime"><option value="">制限なし</option></select><br><br>

      <label>ご予算:　～</label>
      <select id="budget"><option value="">制限なし</option></select>
	  <label>万円</label><br><br>
      <button type="button" onclick="searchRegions()">検索</button>
  </form>
  <hr>
  <h2>検索結果</h2>
  <ul id="results"></ul> <!--検索用ここまで-->
  
  <footer>
    <p>© 2025 TravelMap</p>
  </footer>
  
  <script>
  const PAIRS = [
    ["USD","JPY"],
   ];

  async function fetchRate(base, quote) {
    const res = await fetch(`https://api.frankfurter.app/latest?from=${base}&to=${quote}`, { cache: "no-store" });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    return { rate: data.rates[quote], date: data.date };
  }

  async function refresh() {
    const container = document.getElementById("rates");
    container.innerHTML = "";
    for (const [base, quote] of PAIRS) {
      const row = document.createElement("div");
      row.className = "row";
      const left = document.createElement("div");
      left.textContent = `${base}/${quote}`;
      const right = document.createElement("div");
      right.textContent = "読み込み中…";
      row.append(left, right);
      container.appendChild(row);

      fetchRate(base, quote)
        .then(({rate, date}) => { right.textContent = `${rate.toFixed(4)}  (as of ${date})`; })
        .catch(err => { right.textContent = `ERROR: ${err.message}`; });
    }
  }

  refresh();
  setInterval(refresh, 5_000);
  
  document.addEventListener("DOMContentLoaded",() => { //検索用ここから
	fetch("/api/countries") //国 1027追加
	.then(r => r.json())
	.then(data =>{
		const select=document.getElementById("countryName");
		data.forEach(c =>{
		const opt = document.createElement("option")
		opt.value=c.id;
		opt	.textContent=c.name;
		select.appendChild(opt);	
		});
		});	
		
	fetch("/api/regions/options") //リージョン
	.then(r => r.json())
	.then(data =>{
		const select=document.getElementById("regionId");
		data.forEach(r =>{
			const opt = document.createElement("option");
			opt.value=r.id;
			opt.textContent=r.name;
			select.appendChild(opt);
		});
	});
	fetch("/api/tourist-spots/options") //ツーリストスポット
	.then(r => r.json())
	.then(data => {
		const select=document.getElementById("spotId");
		data.forEach(s => {
			const opt=document.createElement("option");
			opt.value=s.id;
			opt.textContent=s.name;
			select.appendChild(opt);
		});
	});
	fetch("/api/regions/travel-times") //渡航時間
	.then(r => r.json())
	.then(data => {
		const select=document.getElementById("travelTime");
		data.forEach(t => {
			const opt=document.createElement("option");
			opt.value=t;
			opt.textContent=t;
			select.appendChild(opt);
		});
	});
	fetch("/api/regions/budgets") //予算
	.then(r => r.json())
	.then(data => {
		const select=document.getElementById("budget");
		data.forEach(b => {
			const opt=document.createElement("option");
			opt.value=b;
			opt.textContent=b;
			select.appendChild(opt);
		});
	});
  });
  function searchRegions(){
	const params=new URLSearchParams();
	const countryVal = document.getElementById("countryName").value || null;
	const regionVal = document.getElementById("regionId").value || null;
	const spotVal = document.getElementById("spotId").value || null;
	const travelVal = document.getElementById("travelTime").value;
	const budgetVal = document.getElementById("budget").value || null;
	// テスト用 console.log("送信前値：",{regionVal, spotVal, travelVal, budgetVal});
	if(countryVal) params.append("countryName",countryVal);
	if(regionVal) params.append("regionId",regionVal);
	if(spotVal) params.append("spotId",spotVal);
	if(travelVal) params.append("travelTime",travelVal);
	if(budgetVal) params.append("budget",budgetVal);
	// テスト用 console.log("送信するURLSearchParams：", params.toString());
	
	fetch("/api/regions/search?" + params.toString())
	.then(r => {if(!r.ok){
		console.error("サーバエラー",r.status,r.statusText);
	  return [];}  return r.json(); })
	.then(data => {
		const ul = document.getElementById("results");
		ul.innerHTML = "";
		if(!data.length === 0){
			const li = document.createElement("li");
			li.textContent="該当結果なし";
			ul.appendChild(li);
			return;
		}
		data.forEach(r => {
			const li = document.createElement("li");
			li.textContent = 
			`${r.name}(${r.countryName} - Budget: ${r.budget}万円,
			Flight: ${r.flightTime}h)
			- Spots: ${r.spots.join(",")}`;
			ul.appendChild(li);
		});
	}) .catch(err => console.error(err));
  }  //検索用ここまで
  
  
  </script>
  <a th:href="@{/region/001}">
  	 <img th:src="@{/images/region/001.jpg}" alt="ロサンゼルス" style="width:300px; height:auto; margin-right:15px;">
  </a>
  <a th:href="@{/region/002}">
   	 <img th:src="@{/images/region/002.jpg}" alt="ラスベガス" style="width:300px; height:auto; margin-right:15px;">
  </a>
  <a th:href="@{/region/003}">
     <img th:src="@{/images/region/003.jpg}" alt="アリゾナ州" style="width:300px; height:auto; margin-right:15px;">
   </a>
   <a th:href="@{/region/004}">
	 <img th:src="@{/images/region/004.jpg}" alt="ニューヨーク" style="width:300px; height:auto; margin-right:15px;">
   </a>
   <a th:href="@{/region/005}">
	  <img th:src="@{/images/region/005.jpg}" alt="ワシントンD.C." style="width:300px; height:auto; margin-right:15px;">
   </a>
	<a th:href="@{/region/006}">
	   <img th:src="@{/images/region/006.jpg}" alt="フロリダ" style="width:300px; height:auto; margin-right:15px;">
   </a>
   <a th:href="@{/region/007}">
	    <img th:src="@{/images/region/007.jpg}" alt="ハワイ" style="width:300px; height:auto; margin-right:15px;">
   </a>
</body>
</html>
