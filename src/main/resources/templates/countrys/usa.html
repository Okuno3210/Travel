<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>アメリカ観光地ガイド | TravelMap</title>
</head>
<body>
  <header>
    <h1>🇺🇸 アメリカの人気観光地</h1>
    <p>多様な文化と絶景が共存する国 — 自由の女神、グランドキャニオン、ナイアガラの滝など</p>
  </header>
  <main>
    <div th:if="${spots != null and !#lists.isEmpty(spots)}" class="spot-grid">
      <div class="card" th:each="s : ${spots}" th:if="${s.country == 'アメリカ'}">
        <img th:src="${s.image}" th:alt="${s.name}" />
        <div class="card-content">
          <h3 th:text="${s.name}"></h3>
          <p th:text="${s.desc}"></p>
          <a th:href="@{/spots/detail/{key}(key=${s.key})}" class="btn">詳細を見る</a>
        </div>
      </div>
    </div>

    <div th:if="${spots == null or #lists.isEmpty(spots)}">
      <p>アメリカの観光地データが見つかりませんでした。</p>
    </div>
  </main>

 
  <div id="rates"></div>
  
  <form id="searchForm"> <!--検索用ここから-->
    <label>行きたい国:</label>
	<select id="countryId"><option value="">すべて</option></select><br><br>
	
	<label>行きたい地域:</label>
      <select id="regionId"><option value="">すべて</option></select><br><br>
	  
	 <label>ご旅行の目的</label>
	 <select id="<!--conceptId入れる-->"><option value="">何でも</option></select><br><br>

      <label>観光名所:</label>
      <select id="spotId"><option value="">すべて</option></select><br><br>

      <label>渡航時間:</label>
      <select id="travelTime"><option value="">制限なし</option></select><br><br>

      <label>ご予算:　～</label>
      <select id="budget"><option value="">制限なし</option></select>
	  <label>万円</label><br><br>
      <button type="button" onclick="searchRegions()">検索</button>
  </form>
  <hr>
  <h2>検索結果</h2>
  <ul id="results"></ul> <!--検索用ここまで-->
  
  <form th:action="@{/favorites/add/{countryId}(countryId=${country.id})}" method="post" sec:authorize="hasRole('USER')">
        <button type="submit">★ お気に入り登録</button>
    </form>
	
  <footer>
    <p>© 2025 TravelMap</p>
  </footer>
 	
  <script>
  const PAIRS = [
    ["USD","JPY"],
   ];

  async function fetchRate(base, quote) {
    const res = await fetch(`https://api.frankfurter.app/latest?from=${base}&to=${quote}`, { cache: "no-store" });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    return { rate: data.rates[quote], date: data.date };
  }

  async function refresh() {
    const container = document.getElementById("rates");
    container.innerHTML = "";
    for (const [base, quote] of PAIRS) {
      const row = document.createElement("div");
      row.className = "row";
      const left = document.createElement("div");
      left.textContent = `${base}/${quote}`;
      const right = document.createElement("div");
      right.textContent = "読み込み中…";
      row.append(left, right);
      container.appendChild(row);

      fetchRate(base, quote)
        .then(({rate, date}) => { right.textContent = `${rate.toFixed(4)}  (as of ${date})`; })
        .catch(err => { right.textContent = `ERROR: ${err.message}`; });
    }
  }

  refresh();
  setInterval(refresh, 5_000);
  
  document.addEventListener("DOMContentLoaded",() => { //検索用ここから
	fetch("/api/countries/options") //国
	.then(r => r.json())
	.then(data =>{
		const select=document.getElementById("countryId");
		data.forEach(c =>{
		const opt = document.createElement("option")
		opt.value=c.id;
		opt	.textContent=c.name;
		select.appendChild(opt);	
		});
		});	
		
	fetch("/api/regions/options") //リージョン
	.then(r => r.json())
	.then(data =>{
		const select=document.getElementById("regionId");
		data.forEach(r =>{
			const opt = document.createElement("option");
			opt.value=r.id;
			opt.textContent=r.name;
			select.appendChild(opt);
		});
	});
	fetch("/api/tourist-spots/options") //ツーリストスポット
	.then(r => r.json())
	.then(data => {
		const select=document.getElementById("spotId");
		data.forEach(s => {
			const opt=document.createElement("option");
			opt.value=s.id;
			opt.textContent=s.name;
			select.appendChild(opt);
		});
	});
	fetch("/api/regions/travel-times") //渡航時間
	.then(r => r.json())
	.then(data => {
		const select=document.getElementById("travelTime");
		data.forEach(t => {
			const opt=document.createElement("option");
			opt.value=t;
			opt.textContent=t;
			select.appendChild(opt);
		});
	});
	fetch("/api/regions/budgets") //予算
	.then(r => r.json())
	.then(data => {
		const select=document.getElementById("budget");
		data.forEach(b => {
			const opt=document.createElement("option");
			opt.value=b;
			opt.textContent=b;
			select.appendChild(opt);
		});
	});
  });
  function searchRegions(){
	const params=new URLSearchParams();
	const countryVal = document.getElementById("countryId").value || null;
	const regionVal = document.getElementById("regionId").value || null;
	const spotVal = document.getElementById("spotId").value || null;
	const travelVal = document.getElementById("travelTime").value;
	const budgetVal = document.getElementById("budget").value || null;
	// テスト用 console.log("送信前値：",{regionVal, spotVal, travelVal, budgetVal});
	if(countryVal) params.append("countryId",countryVal);
	if(regionVal) params.append("regionId",regionVal);
	if(spotVal) params.append("spotId",spotVal);
	if(travelVal) params.append("travelTime",travelVal);
	if(budgetVal) params.append("budget",budgetVal);
	// テスト用 console.log("送信するURLSearchParams：", params.toString());
	
	fetch("/api/regions/search?" + params.toString())
	.then(r => {if(!r.ok){
		console.error("サーバエラー",r.status,r.statusText);
	  return [];}  return r.json(); })
	.then(data => {
		const ul = document.getElementById("results");
		ul.innerHTML = "";
		if(!data.length === 0){
			const li = document.createElement("li");
			li.textContent="該当結果なし";
			ul.appendChild(li);
			return;
		}
		data.forEach(r => { //検索結果表示
			const li = document.createElement("li");
			li.textContent = 
			`${r.name}(${r.countryName}:${r.countryDescription} 
			- Budget: ${r.budget}万円,Flight: ${r.flightTime}h)
			- Spots: ${r.spots.join(",")}`;
			ul.appendChild(li);
		});
	}) .catch(err => console.error(err));
  }  //検索用ここまで
  
  
  </script>
  
  <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  	<script type="text/javascript" src="/js/script.js"></script>
	
</body>
</html>
